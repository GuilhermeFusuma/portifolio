{% extends "base.html" %}

{% block title %}Projects - Portfolio{% endblock %}

{% block meta_description %}Explore my portfolio of web development projects, featuring modern technologies and innovative solutions.{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold mb-3">Projects</h1>
            <p class="lead text-muted">A showcase of my technical skills and creative solutions</p>
        </div>
    </div>
    
    <!-- Filters Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section bg-light rounded p-4">
                <form method="GET" class="row g-3 align-items-end">
                    <!-- Search -->
                    <div class="col-lg-4 col-md-6">
                        <label for="search" class="form-label fw-bold">Search Projects</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search }}" placeholder="Search by title, description, or technology">
                    </div>
                    
                    <!-- Category Filter -->
                    <div class="col-lg-3 col-md-6">
                        <label for="category" class="form-label fw-bold">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" 
                                    {% if current_category == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Tag Filter -->
                    <div class="col-lg-3 col-md-6">
                        <label for="tag" class="form-label fw-bold">Technology</label>
                        <select class="form-select" id="tag" name="tag">
                            <option value="">All Technologies</option>
                            {% for tag in tags %}
                            <option value="{{ tag.slug }}" 
                                    {% if current_tag == tag.slug %}selected{% endif %}>
                                {{ tag.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Filter Actions -->
                    <div class="col-lg-2 col-md-6">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </form>
                
                <!-- Active Filters -->
                {% if search or current_category or current_tag %}
                <div class="mt-3">
                    <small class="text-muted">Active filters:</small>
                    <div class="d-inline-block ms-2">
                        {% if search %}
                        <span class="badge bg-primary me-1">
                            Search: "{{ search }}"
                            <a href="{{ url_for('projects', category=current_category, tag=current_tag) }}" 
                               class="text-white text-decoration-none ms-1">×</a>
                        </span>
                        {% endif %}
                        {% if current_category %}
                        {% set cat = categories|selectattr('id', 'equalto', current_category)|first %}
                        <span class="badge bg-success me-1">
                            Category: {{ cat.name if cat else 'Unknown' }}
                            <a href="{{ url_for('projects', search=search, tag=current_tag) }}" 
                               class="text-white text-decoration-none ms-1">×</a>
                        </span>
                        {% endif %}
                        {% if current_tag %}
                        {% set tag_obj = tags|selectattr('slug', 'equalto', current_tag)|first %}
                        <span class="badge bg-info me-1">
                            Tech: {{ tag_obj.name if tag_obj else 'Unknown' }}
                            <a href="{{ url_for('projects', search=search, category=current_category) }}" 
                               class="text-white text-decoration-none ms-1">×</a>
                        </span>
                        {% endif %}
                        <a href="{{ url_for('projects') }}" class="btn btn-outline-secondary btn-sm ms-2">
                            Clear All
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Projects Grid -->
    {% if projects.items %}
    <div class="row">
        {% for project in projects.items %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="project-card h-100 animate-on-scroll">
                <!-- Project Image -->
                {% if project.featured_image %}
                <div class="project-image">
                    <img src="{{ url_for('static', filename='uploads/' + project.featured_image) }}" 
                         alt="{{ project.title }}" class="card-img-top">
                    <div class="project-overlay">
                        <div class="project-links">
                            {% if project.demo_url %}
                            <a href="{{ project.demo_url }}" target="_blank" 
                               class="btn btn-light btn-sm me-2" title="Live Demo">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% endif %}
                            {% if project.github_url %}
                            <a href="{{ project.github_url }}" target="_blank" 
                               class="btn btn-light btn-sm" title="View Code">
                                <i class="fab fa-github"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="project-image-placeholder">
                    <i class="fas fa-laptop-code fa-3x text-muted"></i>
                </div>
                {% endif %}
                
                <!-- Project Content -->
                <div class="card-body d-flex flex-column">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">{{ project.title }}</h5>
                        <div class="project-stats">
                            <span class="badge bg-primary me-1" title="Likes">
                                <i class="fas fa-heart"></i> {{ project.get_like_count() }}
                            </span>
                            <span class="badge bg-secondary" title="Views">
                                <i class="fas fa-eye"></i> {{ project.views_count }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Category -->
                    {% if project.category %}
                    <small class="text-primary mb-2">
                        <i class="fas fa-folder me-1"></i>{{ project.category.name }}
                    </small>
                    {% endif %}
                    
                    <!-- Description -->
                    <p class="card-text text-muted mb-3">{{ project.description|truncate_text(120) }}</p>
                    
                    <!-- Technologies -->
                    <div class="project-tech mb-3">
                        {% set technologies = project.technologies|from_json %}
                        {% for tech in technologies[:4] %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ tech }}</span>
                        {% endfor %}
                        {% if technologies|length > 4 %}
                        <span class="badge bg-light text-dark">+{{ technologies|length - 4 }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Tags -->
                    {% if project.tags %}
                    <div class="project-tags mb-3">
                        {% for tag in project.tags[:3] %}
                        <a href="{{ url_for('projects', tag=tag.slug) }}" 
                           class="badge bg-outline-primary text-decoration-none me-1">#{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Actions -->
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('project_detail', slug=project.slug) }}" 
                           class="btn btn-outline-primary">
                            Learn More <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                        
                        <!-- Like Button -->
                        <form method="POST" action="{{ url_for('like_project', slug=project.slug) }}" class="like-form">
                            <button type="submit" class="btn btn-link text-muted p-0 like-btn" 
                                    data-project-id="{{ project.id }}">
                                <i class="fas fa-heart {% if project.is_liked_by(current_user) %}text-danger{% endif %}"></i>
                                <span class="like-count">{{ project.get_like_count() }}</span>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Meta Info -->
                    <small class="text-muted mt-2">
                        <i class="fas fa-calendar me-1"></i>
                        {{ project.created_at|format_date }}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if projects.pages > 1 %}
    <div class="row mt-5">
        <div class="col-12">
            <nav aria-label="Projects pagination">
                <ul class="pagination justify-content-center">
                    <!-- Previous -->
                    {% if projects.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('projects', page=projects.prev_num, 
                           search=search, category=current_category, tag=current_tag) }}">
                            <i class="fas fa-chevron-left me-1"></i>Previous
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- Page Numbers -->
                    {% for page_num in projects.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != projects.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('projects', page=page_num,
                                   search=search, category=current_category, tag=current_tag) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">…</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Next -->
                    {% if projects.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('projects', page=projects.next_num,
                           search=search, category=current_category, tag=current_tag) }}">
                            Next<i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12 text-center py-5">
            <div class="empty-state">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>No Projects Found</h4>
                <p class="text-muted mb-4">
                    {% if search or current_category or current_tag %}
                        No projects match your current filters. Try adjusting your search criteria.
                    {% else %}
                        There are no projects to display at the moment.
                    {% endif %}
                </p>
                {% if search or current_category or current_tag %}
                <a href="{{ url_for('projects') }}" class="btn btn-primary">
                    <i class="fas fa-refresh me-2"></i>Clear Filters
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle like button clicks
document.querySelectorAll('.like-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const btn = this.querySelector('.like-btn');
        const icon = btn.querySelector('i');
        const countSpan = btn.querySelector('.like-count');
        
        // Disable button during request
        btn.disabled = true;
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Update like count
            countSpan.textContent = data.count;
            
            // Update icon color
            if (data.status === 'liked') {
                icon.classList.add('text-danger');
            } else {
                icon.classList.remove('text-danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        })
        .finally(() => {
            btn.disabled = false;
        });
    });
});

// Animate cards on scroll
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('animate-in');
        }
    });
}, observerOptions);

document.querySelectorAll('.animate-on-scroll').forEach(el => {
    observer.observe(el);
});
</script>
{% endblock %}
